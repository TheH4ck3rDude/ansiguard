# Ansible WireGuard Server Setup (Ansiguard)

This guide will help you set up a WireGuard VPN server using Ansible (Ansiguard). The configuration is intended to be executed on the VPS that will be hosting the WireGuard server.

---

## Pre-requisites

### 1. **Create a New User and Add to `sudo` Group**

Create a new user (e.g., `vpnadmin`) on your VPS and grant it sudo privileges:

```bash
sudo adduser vpnadmin
sudo usermod -aG sudo vpnadmin
```

This user will be used to run the Ansible playbooks and manage the VPN server.

### 2. **Install Ansible**

Ensure that Ansible is installed on your local machine. You can install Ansible with the following command:

```bash
sudo apt install ansible-core
```

### 3. **Access the VPS**

Ensure you have SSH access to the VPS where the WireGuard server will be installed.

---

## Directory Structure

To simplify the setup, here’s a high-level directory structure:

```
.
├── .ansible
│   ├── vault
│   └── tmp
├── wg-auto
│   ├── clients
│   ├── group_vars
│   ├── inventory
│   ├── old-loop
│   ├── templates
│   ├── vault
│   ├── deploy_vpn.yml
│   ├── generate_clients.yml
│   └── howManyClients.sh
└── .ansible.cfg
```

- `.ansible/tmp` and `.ansible/` are temporary files generated by Ansible and can be ignored.
- `wg-auto/` contains the necessary playbooks, variables, templates, and scripts for setting up the WireGuard server and generating client configurations.

---

## Setting up the Server and Clients

**Step 1**

- To set up the WireGuard server on your VPS, run the following Ansible command:

```bash
ansible-playbook deploy_vpn.yml -i inventory/hosts.yml -v
```

**Step 2**

- Ensure That The Config Changes Below are Completed Before Continuing the Deployment

**Step 3**

- Generate The Client Config Files

```bash
./howManyClients.sh -n <# of Clients>
```

**Step 4**

- Run the commands from **Step 1** again so that the server config can populate with the newly created client config files.

**Things to Note**

- `deploy_vpn.yml` is the playbook that sets up the WireGuard server.
- `inventory/hosts.yml` contains the configuration for the server and clients.
- `./howManyClients.sh` bash script to auto generate clients and their associated public and private keys.

---

## Configuration Details

### 1. Edit VPN Vault Configuration

Edit the `wg-auto/vault/vpn_vault.yml` file and update the following fields:

```yaml
vpn_host_sudo: "YourUserPasswordHere"
vpn_server_private: "<Generate_Private_Key>"
vpn_server_public: "<Generate_Public_Key>"
```

- `vpn_host_sudo`: Set this to the password of the new user you created in **Pre-requisites Step 1**.
- `vpn_server_private`: Generate it using:

```bash
wg genkey
```

- `vpn_server_public`: Generate it from the private key:

```bash
echo "<private_key>" | wg pubkey
```

### 2. Vault Password for Encryption/Decryption

Generate a random, complex password for Vault encryption/decryption and store it in `~/.ansible/vault`. Run the following command:

```bash
cat /dev/urandom | LC_ALL=C tr -dc 'a-zA-Z0-9!-_' | fold -w 75 | head -n 1 > ~/.ansible/vault
```

### 3. Encrypt the VPN Vault File

Encrypt the VPN vault configuration to secure your sensitive data:

```bash
ansible-vault encrypt wg-auto/vault/vpn_vault.yml
```

If you are prompted to enter the password generated in Step 2. Ensure that the .ansible.cfg file is set to use the vault file at .ansible/vault

This will ensure that your credentials and private keys remain secure.

### 4. Set Server Port

By default, the WireGuard server will run on port `65278`. If you want to use a different port, modify the `listenport` in `group_vars/vpn.yml`.

### 5. Generate Client Configurations

Client configurations are auto-generated using the `howManyClients.sh` script. This script runs the `generate_clients.yml` playbook, which generates all required information for the client and saves it in the `./clients` directory.

The client naming convention follows this format:

- `client_config-<EndIP>.conf`

For example:

- For the first client with an IP of `.5`, the configuration file will be named `client_config-5.conf`.
- The script will automatically increment the client numbers as more clients are created.

### 6. Client Peer Information

The server configuration template (`/templates/wg0.conf.j2`) automatically reads from `group_vars/vpn_dynamic_peers.yml` to add the peer information for each client to the server configuration.

Once the configuration file (e.g., `client_config-5.conf`) is created:

- Place it in the `/etc/wireguard` directory on the client machine.
- To bring up the client, run:

```bash
wg-quick up client_config-5
```

### 7. Verifying Client Connections

You can check if a client has successfully connected by running the following command on the server:

```bash
wg show
```

If the connection is successful, you will see the `latest_handshake` timestamp and details corresponding to when the client connected.

### 8. Generating Multiple Clients

To generate multiple client configurations at once, run the following:

```bash
./howManyClients.sh -n <number_of_clients>
```

For example, to generate 10 client configurations, use:

```bash
./howManyClients.sh -n 10
```

This will generate `client_config-5.conf`, `client_config-6.conf`, and so on.

---

## Summary of Files and Commands

- **Create new user**: `sudo adduser vpnadmin && sudo usermod -aG sudo vpnadmin`
- **Install Ansible**: `sudo apt install ansible-core`
- **Change server port**: Modify `listenport` in `group_vars/vpn.yml`
- **Vault password generation**:
  ```bash
  cat /dev/urandom | LC_ALL=C tr -dc 'a-zA-Z0-9!-_' | fold -w 75 | head -n 1 > ~/.ansible/vault
  ```
- **Encrypt vault file**: `ansible-vault encrypt wg-auto/vault/vpn_vault.yml`
- **Start server**:
  ```bash
  ansible-playbook deploy_vpn.yml -i inventory/hosts.yml -v
  ```
- **Generate clients**: `./howManyClients.sh -n <number>`

---

With this setup, your WireGuard server will be up and running, and you can easily manage client configurations using Ansible. The entire process is automated, ensuring scalability and ease of management for multiple clients.

