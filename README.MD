# Ansible WireGuard Server Setup (Ansiguard)

This guide will help you set up a WireGuard VPN server using Ansible (Ansiguard). The configuration is intended to be executed on the VPS that will be hosting the WireGuard server.

## Pre-requisites

1. **Install Ansible**:
   Ensure that Ansible is installed on your local machine. You can install Ansible with the following command:
   ```bash
   sudo apt install ansible-core
   ```

2. **Access the VPS**:
   You need SSH access to the VPS where you will be running the WireGuard server.

## Directory Structure

To simplify the setup, here’s a high-level directory structure:

```
.
├── .ansible
│   ├── vault
│   └── tmp
├── wg-auto
│   ├── clients
│   ├── group_vars
│   ├── inventory
│   ├── old-loop
│   ├── templates
│   ├── vault
│   ├── deploy_vpn.yml
│   ├── generate_clients.yml
│   └── howManyClients.sh
└── .ansible.cfg
```

- `.ansible/tmp` and `.ansible/` are temporary files generated by Ansible and can be ignored.
- `wg-auto/` contains the necessary playbooks, variables, templates, and scripts for setting up the WireGuard server and generating client configurations.

## Running the Playbook

To set up the WireGuard server on your VPS, run the following Ansible command:

```bash
ansible-playbook deploy_vpn.yml -i inventory/hosts.yml -v
```

- `deploy_vpn.yml` is the playbook that sets up the WireGuard server.
- `inventory/hosts.yml` contains the configuration for the server and clients.

## Configuration Details

### 1. Edit `client.conf.j2` Template

Edit the `/templates/client.conf.j2` file and make the following changes:
- Update the **endpoint IP** to match the IP address of the VPS where the WireGuard server will run.
- Update **allowed IPs**:
   - To route **all traffic** through the VPN, change the `AllowedIPs` value to `0.0.0.0/0` and `::/0`.
   - To allow **specific IPs**, specify the desired IP range instead of `0.0.0.0/0`.

### 2. Vault Password for Encryption/Decryption

Generate a random, complex password for Vault encryption/decryption and store it in `~/.ansible/vault`. Run the following command:

```bash
cat /dev/urandom | LC_ALL=C tr -dc 'a-zA-Z0-9!-_' | fold -w 75 | head -n 1 > ~/.ansible/vault
```

### 3. Set Server Port

By default, the WireGuard server will run on port `65278`. If you want to use a different port, modify the `listenport` in `group_vars/vpn.yml`.

### 4. Generate Client Configurations

Client configurations are auto-generated using the `howManyClients.sh` script. This script runs the `generate_clients.yml` playbook, which generates all required information for the client and saves it in the `./clients` directory.

The client naming convention follows this format:
- `client_config-<EndIP>.conf`

For example:
- For the first client with an IP of `.5`, the configuration file will be named `client_config-5.conf`.
- The script will automatically increment the client numbers as more clients are created.

### 5. Client Peer Information

The server configuration template (`/templates/wg0.conf.j2`) automatically reads from `group_vars/vpn_dynamic_peers.yml` to add the peer information for each client to the server configuration. 

Once the configuration file (e.g., `client_config-5.conf`) is created:
- Place it in the `/etc/wireguard` directory on the client machine.
- To bring up the client, run:
  ```bash
  wg-quick up client_config-5
  ```

### 6. Verifying Client Connections

You can check if a client has successfully connected by running the following command on the server:

```bash
wg show
```

If the connection is successful, you will see the `latest_handshake` timestamp and details corresponding to when the client connected.

### 7. Generating Multiple Clients

To generate multiple client configurations at once, run the following:

```bash
./howManyClients.sh -n <number_of_clients>
```

For example, to generate 10 client configurations, use:
```bash
./howManyClients.sh -n 10
```

This will generate `client_config-5.conf`, `client_config-6.conf`, and so on.

---

## Summary of Files and Commands

- **How to change server port**: Modify the `listenport` value in `group_vars/vpn.yml`.
- **Client config generation**: Use `howManyClients.sh` with the `-n` flag to specify the number of clients to generate.
- **Vault password generation**: Run `cat /dev/urandom | LC_ALL=C tr -dc 'a-zA-Z0-9!-_' | fold -w 75 | head -n 1 > ~/.ansible/vault` to create a vault password.
- **Server start**: Run `ansible-playbook deploy_vpn.yml -i inventory/hosts.yml -v` to start the WireGuard server.

---

With this setup, your WireGuard server will be up and running, and you can easily manage client configurations using Ansible. The entire process is automated, ensuring scalability and ease of management for multiple clients.

